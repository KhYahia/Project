<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FreshChain – Blockchain Supply Chain</title>
</head>

<body>

<h2>FreshChain – Blockchain Supply Chain</h2>

<button id="connectBtn">Connect MetaMask</button>
<p><b>Connected account:</b> <span id="account">-</span></p>

<hr>

<h3>Producer</h3>
<input id="bid" placeholder="Batch ID">
<input id="productName" placeholder="Product Name">
<input id="qty" placeholder="Quantity">
<button id="createBtn" disabled>Create Batch</button>

<hr>

<h3>Transporter</h3>
<input id="sid" placeholder="Batch ID">
<input id="temp" placeholder="Temperature">
<input id="hum" placeholder="Humidity">
<input id="loc" placeholder="Location">
<button id="sensorBtn" disabled>Add Sensor Data</button>

<hr>

<h3>Ownership Transfer</h3>
<input id="tid" placeholder="Batch ID">
<input id="to" placeholder="New Owner Address">
<button id="transferBtn" disabled>Transfer Ownership</button>

<hr>

<h3>Retailer</h3>
<input id="rid" placeholder="Batch ID">
<button id="arriveBtn" disabled>Mark As Arrived</button>

<hr>

<h3>Customer</h3>
<input id="vid" placeholder="Batch ID">
<button id="viewBtn" disabled>View History</button>

<pre id="out"></pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
/* ===============================
   CONFIGURATION
================================ */
const CONTRACT_ADDRESS = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";

const ABI = [
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"int256","name":"temperature","type":"int256"},{"internalType":"int256","name":"humidity","type":"int256"},{"internalType":"string","name":"location","type":"string"}],"name":"addSensorData","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"createBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"bool","name":"passed","type":"bool"}],"name":"markAsArrived","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"}],"name":"getBatchHistory","outputs":[{"components":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"uint256","name":"quantity","type":"uint256"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"bool","name":"arrived","type":"bool"},{"internalType":"bool","name":"inspectionPassed","type":"bool"},{"components":[{"internalType":"int256","name":"temperature","type":"int256"},{"internalType":"int256","name":"humidity","type":"int256"},{"internalType":"string","name":"location","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"transporter","type":"address"}],"internalType":"struct FreshChain.SensorData[]","name":"sensors","type":"tuple[]"},{"components":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FreshChain.Ownership[]","name":"ownerships","type":"tuple[]"},{"internalType":"bool","name":"exists","type":"bool"}],"internalType":"struct FreshChain.Batch","name":"","type":"tuple"}],"stateMutability":"view","type":"function"}
];

let provider, signer, contract;

/* ===============================
   CONNECT METAMASK
================================ */
connectBtn.onclick = async () => {
  if (!window.ethereum) {
    alert("MetaMask is not installed");
    return;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  account.innerText = await signer.getAddress();

  createBtn.disabled = false;
  sensorBtn.disabled = false;
  transferBtn.disabled = false;
  arriveBtn.disabled = false;
  viewBtn.disabled = false;
};

/* ===============================
   CREATE BATCH
================================ */
createBtn.onclick = async () => {
  try {
    if (isNaN(bid.value))
      throw new Error("Batch ID must be a number");

    if (!productName.value.trim())
      throw new Error("Product name is required");

    if (isNaN(qty.value))
      throw new Error("Quantity must be a number");

    const batchId = Number(bid.value);

    const tx = await contract.createBatch(
      batchId,
      productName.value.trim(),
      Number(qty.value)
    );

    alert("Transaction sent:\n" + tx.hash);

  } catch (e) {
    if (e.message.includes("Batch exists")) {
      alert(
        `Batch ID ${bid.value} already exists.\n` +
        `Please use a different batch ID or redeploy the contract to reset the data.`
      );
    } else {
      alert(e.message);
    }
  }
};

/* ===============================
   ADD SENSOR DATA
================================ */
sensorBtn.onclick = async () => {
  try {
    if (isNaN(sid.value)) throw new Error("Batch ID must be a number");
    if (isNaN(temp.value)) throw new Error("Temperature must be a number");
    if (isNaN(hum.value)) throw new Error("Humidity must be a number");

    const humidity = Number(hum.value);
    if (humidity < 0 || humidity > 100)
      throw new Error("Enter valid humidity between 0 and 100");

    if (!loc.value.trim())
      throw new Error("Location is required");

    const tx = await contract.addSensorData(
      Number(sid.value),
      Number(temp.value),
      humidity,
      loc.value.trim()
    );

    alert("Transaction sent:\n" + tx.hash);

  } catch (e) {
    alert(e.message);
  }
};

/* ===============================
   TRANSFER OWNERSHIP
================================ */
transferBtn.onclick = async () => {
  try {
    if (isNaN(tid.value))
      throw new Error("Batch ID must be a number");

    const address = to.value.trim();
    if (!address)
      throw new Error("New owner address is required");

    if (!ethers.utils.isAddress(address))
      throw new Error("Enter a valid Ethereum address");

    const tx = await contract.transferOwnership(
      Number(tid.value),
      address
    );

    alert("Transaction sent:\n" + tx.hash);

  } catch (e) {
    alert(e.message);
  }
};

/* ===============================
   MARK AS ARRIVED
================================ */
arriveBtn.onclick = async () => {
  try {
    if (isNaN(rid.value))
      throw new Error("Batch ID must be a number");

    const tx = await contract.markAsArrived(Number(rid.value), true);
    alert("Transaction sent:\n" + tx.hash);

  } catch (e) {
    alert(e.message);
  }
};

/* ===============================
   VIEW HISTORY
================================ */
viewBtn.onclick = async () => {
  try {
    if (isNaN(vid.value))
      throw new Error("Batch ID must be a number");

    const data = await contract.getBatchHistory(Number(vid.value));
    out.innerText = JSON.stringify(data, null, 2);

  } catch (e) {
    alert(e.message);
  }
};
</script>

</body>
</html>


