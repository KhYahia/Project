<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Management Panels</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 24px; }
h2 { margin-top: 0; }

.card {
  border: 1px solid #ddd;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 16px;
}

.row { display: flex; gap: 10px; flex-wrap: wrap; margin: 8px 0; }

input, select, button {
  padding: 8px;
  font-size: 14px;
}

button { cursor: pointer; }

.hidden { display: none; }

.status {
  margin-top: 10px;
  padding: 10px;
  border-radius: 6px;
  display: none;
  white-space: pre-line;
}

.status.ok {
  background: #e6fffa;
  color: #065f46;
  border: 1px solid #10b981;
}

.status.err {
  background: #fee2e2;
  color: #7f1d1d;
  border: 1px solid #ef4444;
}
</style>
</head>

<body>

<h2>FreshChain – Management Panels</h2>

<!-- CONNECT -->
<div class="card">
  <button id="connectBtn">Connect MetaMask</button>
  <p><b>Account:</b> <span id="account">-</span></p>
  <p><b>Network:</b> <span id="network">-</span></p>

  <select id="roleSelect" disabled>
    <option value="">Select role</option>
    <option value="admin">Admin</option>
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="distributor">Distributor</option>
    <option value="retailer">Retailer</option>
    <option value="customer">Customer</option>
  </select>
</div>

<!-- ADMIN -->
<div class="card hidden" id="admin">
  <h3>Admin – Register Roles</h3>
  <input id="regAddr" placeholder="0x user address">
  <div class="row">
    <button onclick="registerRole('registerProducer')">Producer</button>
    <button onclick="registerRole('registerTransporter')">Transporter</button>
    <button onclick="registerRole('registerDistributor')">Distributor</button>
    <button onclick="registerRole('registerRetailer')">Retailer</button>
  </div>
  <div id="adminStatus" class="status"></div>
</div>

<!-- PRODUCER -->
<div class="card hidden" id="producer">
  <h3>Producer – Create Batch</h3>
  <input id="p_id" placeholder="Batch ID (number)">
  <input id="p_name" placeholder="Product name">
  <input id="p_qty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
  <div id="producerStatus" class="status"></div>
</div>

<!-- TRANSPORTER -->
<div class="card hidden" id="transporter">
  <h3>Transporter – Add Sensor Data</h3>
  <input id="t_id" placeholder="Batch ID (number)">
  <input id="t_temp" placeholder="Temperature">
  <input id="t_hum" placeholder="Humidity (0–100)">
  <input id="t_loc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor Data</button>
  <div id="transporterStatus" class="status"></div>
</div>

<!-- DISTRIBUTOR -->
<div class="card hidden" id="distributor">
  <h3>Distributor – Transfer Ownership</h3>
  <input id="d_id" placeholder="Batch ID (number)">
  <input id="d_to" placeholder="New owner address">
  <button onclick="transferOwner()">Transfer Ownership</button>
  <div id="distributorStatus" class="status"></div>
</div>

<!-- RETAILER -->
<div class="card hidden" id="retailer">
  <h3>Retailer – Mark As Arrived</h3>
  <input id="r_id" placeholder="Batch ID (number)">
  <select id="r_passed">
    <option value="true">Inspection Passed</option>
    <option value="false">Inspection Failed</option>
  </select>
  <button onclick="markArrived()">Mark Arrived</button>
  <div id="retailerStatus" class="status"></div>
</div>

<!-- CUSTOMER -->
<div class="card hidden" id="customer">
  <h3>Customer – Generate QR Code</h3>
  <p>Product history is accessible only via QR scan.</p>

  <input id="qrId" placeholder="Batch ID (number)">
  <button onclick="generateQR()">Generate QR</button>

  <br><br>
  <img id="qrImg">
  <p id="qrLink"></p>

  <div id="customerStatus" class="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONTRACT = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";

const ABI = [
  "function createBatch(uint256,string,uint256)",
  "function addSensorData(uint256,int256,int256,string)",
  "function transferOwnership(uint256,address)",
  "function markAsArrived(uint256,bool)",
  "function registerProducer(address)",
  "function registerTransporter(address)",
  "function registerDistributor(address)",
  "function registerRetailer(address)"
];

let provider, signer, contract;

function showStatus(id, msg, ok=false) {
  const el = document.getElementById(id);
  el.style.display = "block";
  el.className = "status " + (ok ? "ok" : "err");
  el.innerText = msg;
}

connectBtn.onclick = async () => {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT, ABI, signer);

  account.innerText = await signer.getAddress();
  network.innerText = (await provider.getNetwork()).name;
  roleSelect.disabled = false;
};

roleSelect.onchange = e => {
  ["admin","producer","transporter","distributor","retailer","customer"]
    .forEach(r => document.getElementById(r).classList.add("hidden"));
  if (e.target.value)
    document.getElementById(e.target.value).classList.remove("hidden");
};

/* ADMIN */
async function registerRole(fn) {
  if (!ethers.utils.isAddress(regAddr.value))
    return showStatus("adminStatus","❌ Invalid Ethereum address.");

  try {
    await contract[fn](regAddr.value);
    showStatus("adminStatus","✅ Role registered successfully.",true);
  } catch {
    showStatus("adminStatus","❌ Only contract owner can register roles.");
  }
}

/* PRODUCER */
async function createBatch() {
  if (!p_id.value || isNaN(p_id.value))
    return showStatus("producerStatus","❌ Batch ID must be a number.");
  if (!p_name.value)
    return showStatus("producerStatus","❌ Product name is required.");
  if (!p_qty.value || isNaN(p_qty.value) || p_qty.value <= 0)
    return showStatus("producerStatus","❌ Quantity must be a positive number.");

  try {
    await contract.createBatch(Number(p_id.value), p_name.value, Number(p_qty.value));
    showStatus("producerStatus",`✅ Batch ${p_id.value} created successfully.`,true);
  } catch {
    showStatus("producerStatus",
      `❌ Batch ID ${p_id.value} already exists\nor you are not registered as Producer.`);
  }
}

/* TRANSPORTER */
async function addSensor() {
  if (!t_id.value || isNaN(t_id.value))
    return showStatus("transporterStatus","❌ Batch ID must be a number.");
  if (!t_hum.value || isNaN(t_hum.value) || t_hum.value < 0 || t_hum.value > 100)
    return showStatus("transporterStatus","❌ Humidity must be between 0 and 100.");

  try {
    await contract.addSensorData(
      Number(t_id.value),
      Number(t_temp.value),
      Number(t_hum.value),
      t_loc.value
    );
    showStatus("transporterStatus","✅ Sensor data added successfully.",true);
  } catch {
    showStatus("transporterStatus",
      "❌ Invalid Batch ID or you are not registered as Transporter.");
  }
}

/* DISTRIBUTOR */
async function transferOwner() {
  if (!d_id.value || isNaN(d_id.value))
    return showStatus("distributorStatus","❌ Batch ID must be a number.");
  if (!ethers.utils.isAddress(d_to.value))
    return showStatus("distributorStatus","❌ Invalid Ethereum address.");

  try {
    await contract.transferOwnership(Number(d_id.value), d_to.value);
    showStatus("distributorStatus","✅ Ownership transferred successfully.",true);
  } catch {
    showStatus("distributorStatus",
      "❌ Transfer failed.\nYou may not be the current owner.");
  }
}

/* RETAILER */
async function markArrived() {
  if (!r_id.value || isNaN(r_id.value))
    return showStatus("retailerStatus","❌ Batch ID must be a number.");

  try {
    await contract.markAsArrived(Number(r_id.value), r_passed.value==="true");
    showStatus("retailerStatus","✅ Batch marked as arrived.",true);
  } catch {
    showStatus("retailerStatus",
      "❌ Operation failed.\nYou are not registered as Retailer.");
  }
}

/* CUSTOMER – QR */
function generateQR() {
  if (!qrId.value || isNaN(qrId.value))
    return showStatus("customerStatus","❌ Batch ID must be a number.");

  const url =
    `${location.origin}${location.pathname.replace("index.html","")}` +
    `scan.html?batchId=${qrId.value}`;

  qrImg.src =
    `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=` +
    encodeURIComponent(url);

  qrLink.innerText = url;

  showStatus("customerStatus",
    "✅ QR generated.\nScan to view full product history.", true);
}
</script>

</body>
</html>

