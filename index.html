<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FreshChain – Management Panels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background:#f8f9fa; }
    h2 { margin-bottom: 10px; }
    h3 { margin-top: 0; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:16px; margin-bottom:20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    input, select, button { padding:8px; font-size:14px; }
    input { min-width:160px; }
    button { cursor:pointer; }
    .hidden { display:none; }
    .error { background:#ffe6e6; color:#900; padding:10px; border-radius:6px; margin-top:10px; }
    .success { background:#e6ffea; color:#065f46; padding:10px; border-radius:6px; margin-top:10px; }
    pre { background:#f1f1f1; padding:12px; border-radius:6px; white-space:pre-wrap; }
  </style>
</head>

<body>

<h2>FreshChain – Management Panels</h2>

<!-- CONNECTION -->
<div class="card">
  <button id="connectBtn">Connect MetaMask</button>
  <p><b>Account:</b> <span id="account">-</span></p>
  <p><b>Network:</b> <span id="network">-</span></p>

  <div class="row">
    <label><b>Select Role:</b></label>
    <select id="roleSelect" disabled>
      <option value="">Choose…</option>
      <option value="producer">Producer</option>
      <option value="transporter">Transporter</option>
      <option value="distributor">Distributor</option>
      <option value="retailer">Retailer</option>
      <option value="customer">Customer</option>
    </select>
  </div>
</div>

<!-- PRODUCER -->
<div class="card hidden" id="producerPanel">
  <h3>Producer – Create Batch</h3>
  <div class="row">
    <input id="pBatch" placeholder="Batch ID">
    <input id="pName" placeholder="Product Name">
    <input id="pQty" placeholder="Quantity">
    <button id="createBatchBtn">Create Batch</button>
  </div>
  <div id="producerMsg"></div>
</div>

<!-- TRANSPORTER -->
<div class="card hidden" id="transporterPanel">
  <h3>Transporter – Add Sensor Data</h3>
  <div class="row">
    <input id="tBatch" placeholder="Batch ID">
    <input id="tTemp" placeholder="Temperature">
    <input id="tHum" placeholder="Humidity">
    <input id="tLoc" placeholder="Location">
    <button id="addSensorBtn">Add Sensor Data</button>
  </div>
  <div id="transporterMsg"></div>
</div>

<!-- DISTRIBUTOR -->
<div class="card hidden" id="distributorPanel">
  <h3>Distributor – Transfer Ownership</h3>
  <div class="row">
    <input id="dBatch" placeholder="Batch ID">
    <input id="dTo" placeholder="New Owner Address">
    <button id="transferBtn">Transfer</button>
  </div>
  <div id="distributorMsg"></div>
</div>

<!-- RETAILER -->
<div class="card hidden" id="retailerPanel">
  <h3>Retailer – Mark Arrived</h3>
  <div class="row">
    <input id="rBatch" placeholder="Batch ID">
    <select id="rPassed">
      <option value="true">Inspection Passed</option>
      <option value="false">Inspection Failed</option>
    </select>
    <button id="arrivedBtn">Mark Arrived</button>
  </div>
  <div id="retailerMsg"></div>
</div>

<!-- CUSTOMER -->
<div class="card hidden" id="customerPanel">
  <h3>Customer – View History</h3>

  <div class="row">
    <input id="cBatch" placeholder="Batch ID">
    <button id="viewHistoryBtn">View History</button>
  </div>

  <pre id="historyOut">History will appear here…</pre>

  <h4>Generate QR Code</h4>
  <div class="row">
    <input id="qrBatch" placeholder="Batch ID">
    <button id="qrBtn">Generate QR</button>
  </div>
  <div id="qr"></div>
  <p id="qrLink"></p>
</div>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";
const ABI = [
  "function createBatch(uint256,string,uint256)",
  "function addSensorData(uint256,int256,int256,string)",
  "function transferOwnership(uint256,address)",
  "function markAsArrived(uint256,bool)",
  "function getBatchHistory(uint256) view returns (tuple(uint256,string,uint256,address,bool,bool,tuple(int256,int256,string,uint256,address)[],tuple(address,address,uint256)[],bool))"
];

let provider, signer, contract, account;

/* ================= HELPERS ================= */
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function err(el,msg){ el.innerHTML = `<div class="error">❌ ${msg}</div>`; }
function ok(el,msg){ el.innerHTML = `<div class="success">✅ ${msg}</div>`; }

/* ================= CONNECT ================= */
connectBtn.onclick = async () => {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  account = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  accountSpan.textContent = account;
  network.textContent = (await provider.getNetwork()).name;
  roleSelect.disabled = false;
};

/* ================= ROLE SWITCH ================= */
roleSelect.onchange = () => {
  ["producerPanel","transporterPanel","distributorPanel","retailerPanel","customerPanel"]
    .forEach(id => hide(document.getElementById(id)));

  if(roleSelect.value)
    show(document.getElementById(roleSelect.value + "Panel"));
};

/* ================= PRODUCER ================= */
createBatchBtn.onclick = async () => {
  producerMsg.innerHTML="";
  try{
    await contract.createBatch(pBatch.value,pName.value,pQty.value);
    ok(producerMsg,"Batch created");
  }catch(e){ err(producerMsg,e.reason||"Failed"); }
};

/* ================= TRANSPORTER ================= */
addSensorBtn.onclick = async () => {
  transporterMsg.innerHTML="";
  try{
    await contract.addSensorData(tBatch.value,tTemp.value,tHum.value,tLoc.value);
    ok(transporterMsg,"Sensor data added");
  }catch(e){ err(transporterMsg,e.reason||"Invalid batch or not transporter"); }
};

/* ================= DISTRIBUTOR ================= */
transferBtn.onclick = async () => {
  distributorMsg.innerHTML="";
  try{
    await contract.transferOwnership(dBatch.value,dTo.value);
    ok(distributorMsg,"Ownership transferred");
  }catch(e){ err(distributorMsg,e.reason||"Transfer failed"); }
};

/* ================= RETAILER ================= */
arrivedBtn.onclick = async () => {
  retailerMsg.innerHTML="";
  try{
    await contract.markAsArrived(rBatch.value,rPassed.value==="true");
    ok(retailerMsg,"Batch marked arrived");
  }catch(e){ err(retailerMsg,e.reason||"Failed"); }
};

/* ================= CUSTOMER ================= */
viewHistoryBtn.onclick = async () => {
  const b = await contract.getBatchHistory(cBatch.value);
  historyOut.textContent =
`Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}
Owner: ${b[3]}
Arrived: ${b[4]}
Inspection Passed: ${b[5]}
Sensors: ${b[6].length}
Transfers: ${b[7].length}`;
};

/* ================= QR ================= */
qrBtn.onclick = () => {
  qr.innerHTML="";
  const url = `${location.origin}${location.pathname.replace("index.html","")}scan.html?batchId=${qrBatch.value}`;
  new QRCode(qr,url);
  qrLink.textContent = url;
};
</script>

</body>
</html>


