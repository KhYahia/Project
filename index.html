<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FreshChain – All-in-One Frontend</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    h2 { margin-top: 0; }
    h3 { margin-bottom: 6px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 8px 0; }
    input, select, button { padding: 8px; font-size: 14px; }
    input { min-width: 180px; }
    button { cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin: 14px 0; }
    .muted { color: #666; }
    .hidden { display: none; }
    .ok { color: #0a7; }
    .bad { color: #c00; }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #fafafa;
      border: 1px solid #eee;
      padding: 12px;
      border-radius: 10px;
    }
    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background:#f2f2f2;
      margin-left: 8px;
      font-size: 12px;
    }
  </style>
</head>

<body>

<h2>FreshChain – All-in-One Frontend</h2>

<!-- CONNECT -->
<div class="card">
  <div class="row">
    <button id="connectBtn">Connect MetaMask</button>
    <span class="muted">Network:</span> <b id="netName">-</b>
    <span class="muted">Contract:</span> <b id="contractAddr">-</b>
  </div>

  <div class="row">
    <span class="muted">Account:</span> <b id="account">-</b>
    <span class="tag" id="roleTag">Role: -</span>
  </div>

  <div class="row">
    <label class="muted">Select Role:</label>
    <select id="roleSelect" disabled>
      <option value="">Choose…</option>
      <option value="admin">Admin</option>
      <option value="producer">Producer</option>
      <option value="transporter">Transporter</option>
      <option value="distributor">Distributor</option>
      <option value="retailer">Retailer</option>
      <option value="customer">Customer</option>
    </select>
    <span class="muted" id="roleHint">Connect MetaMask first.</span>
  </div>
</div>

<!-- ADMIN -->
<div class="card hidden" id="adminSection">
  <h3>Admin Panel (Register roles)</h3>
  <input id="regAddr" placeholder="User address (0x...)" />
  <div class="row">
    <button id="regProducerBtn" disabled>Register Producer</button>
    <button id="regTransporterBtn" disabled>Register Transporter</button>
    <button id="regDistributorBtn" disabled>Register Distributor</button>
    <button id="regRetailerBtn" disabled>Register Retailer</button>
  </div>
</div>

<!-- PRODUCER -->
<div class="card hidden" id="producerSection">
  <h3>Producer</h3>
  <div class="row">
    <input id="bid" placeholder="Batch ID" />
    <input id="productName" placeholder="Product name" />
    <input id="qty" placeholder="Quantity" />
    <button id="createBtn" disabled>Create Batch</button>
  </div>
</div>

<!-- TRANSPORTER -->
<div class="card hidden" id="transporterSection">
  <h3>Transporter</h3>
  <div class="row">
    <input id="sid" placeholder="Batch ID" />
    <input id="temp" placeholder="Temperature" />
    <input id="hum" placeholder="Humidity (0–100)" />
    <input id="loc" placeholder="Location" />
    <button id="sensorBtn" disabled>Add Sensor Data</button>
  </div>
</div>

<!-- DISTRIBUTOR -->
<div class="card hidden" id="distributorSection">
  <h3>Distributor / Ownership Transfer</h3>
  <div class="row">
    <input id="tid" placeholder="Batch ID" />
    <input id="to" placeholder="New Owner Address" />
    <button id="transferBtn" disabled>Transfer Ownership</button>
  </div>
</div>

<!-- RETAILER -->
<div class="card hidden" id="retailerSection">
  <h3>Retailer</h3>
  <div class="row">
    <input id="rid" placeholder="Batch ID" />
    <select id="passedSel">
      <option value="true">Inspection Passed</option>
      <option value="false">Inspection Failed</option>
    </select>
    <button id="arriveBtn" disabled>Mark As Arrived</button>
  </div>
</div>

<!-- CUSTOMER -->
<div class="card hidden" id="customerSection">
  <h3>Customer</h3>

  <div class="row">
    <input id="vid" placeholder="Batch ID" />
    <button id="viewBtn" disabled>View History</button>
  </div>

  <h4>QR Code</h4>
  <div class="row">
    <input id="qrBatchId" placeholder="Batch ID for QR" />
    <button id="qrBtn">Generate QR</button>
  </div>

  <div id="qrBox"></div>
  <div class="muted" id="qrLink"></div>

  <pre id="out">History output will appear here…</pre>
</div>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";
const SEPOLIA_CHAIN_ID = 11155111;

const ABI = [
  "function createBatch(uint256,string,uint256)",
  "function addSensorData(uint256,int256,int256,string)",
  "function transferOwnership(uint256,address)",
  "function markAsArrived(uint256,bool)",
  "function getBatchHistory(uint256) view returns (tuple(uint256,string,uint256,address,bool,bool,tuple(int256,int256,string,uint256,address)[],tuple(address,address,uint256)[],bool))",
  "function registerProducer(address)",
  "function registerTransporter(address)",
  "function registerDistributor(address)",
  "function registerRetailer(address)",
  "function isProducer(address) view returns (bool)",
  "function isTransporter(address) view returns (bool)",
  "function isDistributor(address) view returns (bool)",
  "function isRetailer(address) view returns (bool)",
  "function owner() view returns (address)"
];

let provider, signer, contract, account;

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);
const num = (v,l)=>{ if(v===""||isNaN(v)) throw `${l} must be a number`; return Number(v); };
const txt = (v,l)=>{ if(!v) throw `${l} required`; return v; };
const addr = (v,l)=>{ if(!ethers.utils.isAddress(v)) throw `Invalid ${l}`; return v; };

function hideAll(){
  ["admin","producer","transporter","distributor","retailer","customer"]
  .forEach(r => $(r+"Section").classList.add("hidden"));
}

function showRole(r){ hideAll(); if(r) $(r+"Section").classList.remove("hidden"); }

/* ================= CONNECT ================= */
$("connectBtn").onclick = async ()=>{
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer = provider.getSigner();
  account = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  $("account").textContent = account;
  $("contractAddr").textContent = CONTRACT_ADDRESS;
  $("roleSelect").disabled = false;
  $("netName").textContent = "Sepolia";

  ["createBtn","sensorBtn","transferBtn","arriveBtn","viewBtn",
   "regProducerBtn","regTransporterBtn","regDistributorBtn","regRetailerBtn"]
   .forEach(id=>$(id).disabled=false);
};

/* ================= ROLE SELECT ================= */
$("roleSelect").onchange = ()=> showRole($("roleSelect").value);

/* ================= ADMIN ================= */
const reg = fn => async ()=>{
  try { await contract[fn](addr($("regAddr").value,"address")); alert("Registered"); }
  catch(e){ alert(e.message||e); }
};
regProducerBtn.onclick=reg("registerProducer");
regTransporterBtn.onclick=reg("registerTransporter");
regDistributorBtn.onclick=reg("registerDistributor");
regRetailerBtn.onclick=reg("registerRetailer");

/* ================= PRODUCER ================= */
createBtn.onclick = async ()=>{
  try {
    await contract.createBatch(
      num(bid.value,"Batch ID"),
      txt(productName.value,"Product"),
      num(qty.value,"Quantity")
    );
    alert("Batch created");
  } catch(e){ alert(e.message||e); }
};

/* ================= TRANSPORTER ================= */
sensorBtn.onclick = async ()=>{
  try {
    const h = num(hum.value,"Humidity");
    if(h<0||h>100) throw "Humidity 0–100";
    await contract.addSensorData(
      num(sid.value,"Batch ID"),
      num(temp.value,"Temp"),
      h,
      txt(loc.value,"Location")
    );
    alert("Sensor data added");
  } catch(e){ alert(e.message||e); }
};

/* ================= DISTRIBUTOR ================= */
transferBtn.onclick = async ()=>{
  try {
    await contract.transferOwnership(
      num(tid.value,"Batch ID"),
      addr(to.value,"address")
    );
    alert("Ownership transferred");
  } catch(e){ alert(e.message||e); }
};

/* ================= RETAILER ================= */
arriveBtn.onclick = async ()=>{
  try {
    await contract.markAsArrived(
      num(rid.value,"Batch ID"),
      passedSel.value==="true"
    );
    alert("Marked arrived");
  } catch(e){ alert(e.message||e); }
};

/* ================= CUSTOMER ================= */
viewBtn.onclick = async ()=>{
  try {
    const b = await contract.getBatchHistory(num(vid.value,"Batch ID"));
    let out = `
Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}
Owner: ${b[3]}
Arrived: ${b[4]}
Inspection: ${b[5]}

Sensor Logs: ${b[6].length}
Ownership Transfers: ${b[7].length}
`;
    $("out").textContent = out;
  } catch(e){ alert(e.message||e); }
};

/* ================= QR ================= */
const BASE = location.origin + location.pathname;

qrBtn.onclick = ()=>{
  const id = qrBatchId.value;
  const url = `${BASE}?batchId=${id}`;
  qrBox.innerHTML="";
  new QRCode(qrBox,{text:url,width:160,height:160});
  qrLink.textContent=url;
};

/* ================= AUTO LOAD QR ================= */
window.onload = ()=>{
  const id = new URLSearchParams(location.search).get("batchId");
  if(id){
    roleSelect.value="customer";
    showRole("customer");
    vid.value=id;
  }
};
</script>

</body>
</html>
