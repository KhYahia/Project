<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FreshChain – All-in-One Frontend</title>

<style>
body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
h2 { margin-top: 0; }
.card { border:1px solid #ddd; border-radius:10px; padding:14px; margin:14px 0; }
.row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0; }
input, select, button { padding:8px; font-size:14px; }
input { min-width:180px; }
button { cursor:pointer; }
.hidden { display:none; }
pre { background:#fafafa; padding:12px; border-radius:10px; border:1px solid #eee; }
.muted { color:#666; }
.tag { background:#f2f2f2; padding:2px 8px; border-radius:999px; font-size:12px; }
</style>
</head>

<body>

<h2>FreshChain – All-in-One Frontend</h2>

<!-- CONNECT -->
<div class="card">
  <div class="row">
    <button id="connectBtn">Connect MetaMask</button>
    <span class="muted">Network:</span><b id="net">-</b>
    <span class="muted">Contract:</span><b id="caddr">-</b>
  </div>
  <div class="row">
    <span class="muted">Account:</span><b id="account">-</b>
    <span class="tag" id="roles">Role: -</span>
  </div>
  <div class="row">
    <label class="muted">Select Role:</label>
    <select id="roleSelect" disabled>
      <option value="">Choose…</option>
      <option value="admin">Admin</option>
      <option value="producer">Producer</option>
      <option value="transporter">Transporter</option>
      <option value="distributor">Distributor</option>
      <option value="retailer">Retailer</option>
      <option value="customer">Customer</option>
    </select>
  </div>
</div>

<!-- ADMIN -->
<div class="card hidden" id="admin">
<h3>Admin Panel</h3>
<input id="regAddr" placeholder="User address (0x…)">
<div class="row">
<button onclick="reg('registerProducer')">Register Producer</button>
<button onclick="reg('registerTransporter')">Register Transporter</button>
<button onclick="reg('registerDistributor')">Register Distributor</button>
<button onclick="reg('registerRetailer')">Register Retailer</button>
</div>
</div>

<!-- PRODUCER -->
<div class="card hidden" id="producer">
<h3>Producer</h3>
<input id="pbid" placeholder="Batch ID">
<input id="pname" placeholder="Product Name">
<input id="pqty" placeholder="Quantity">
<button onclick="createBatch()">Create Batch</button>
</div>

<!-- TRANSPORTER -->
<div class="card hidden" id="transporter">
<h3>Transporter</h3>
<input id="tbid" placeholder="Batch ID">
<input id="temp" placeholder="Temperature">
<input id="hum" placeholder="Humidity (0–100)">
<input id="loc" placeholder="Location">
<button onclick="addSensor()">Add Sensor Data</button>
</div>

<!-- DISTRIBUTOR -->
<div class="card hidden" id="distributor">
<h3>Distributor</h3>
<input id="dbid" placeholder="Batch ID">
<input id="newOwner" placeholder="New Owner Address">
<button onclick="transfer()">Transfer Ownership</button>
</div>

<!-- RETAILER -->
<div class="card hidden" id="retailer">
<h3>Retailer</h3>
<input id="rbid" placeholder="Batch ID">
<select id="passed">
<option value="true">Inspection Passed</option>
<option value="false">Inspection Failed</option>
</select>
<button onclick="arrive()">Mark Arrived</button>
</div>

<!-- CUSTOMER -->
<div class="card hidden" id="customer">
<h3>Customer</h3>
<input id="cbid" placeholder="Batch ID">
<button onclick="view()">View History</button>

<h4>QR Code</h4>
<input id="qrid" placeholder="Batch ID for QR">
<button onclick="genQR()">Generate QR</button>
<br><br>
<img id="qr" />
<pre id="out">History will appear here…</pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
const CONTRACT="0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";
const ABI=[ /* SAME ABI YOU USED – UNCHANGED */ ];

let provider, signer, contract, acc;

const $=id=>document.getElementById(id);
const hide=()=>["admin","producer","transporter","distributor","retailer","customer"]
.forEach(i=>$(i).classList.add("hidden"));

$("connectBtn").onclick=async()=>{
provider=new ethers.providers.Web3Provider(window.ethereum);
await provider.send("eth_requestAccounts",[]);
signer=provider.getSigner();
acc=await signer.getAddress();
contract=new ethers.Contract(CONTRACT,ABI,signer);
$("account").textContent=acc;
$("caddr").textContent=CONTRACT;
$("net").textContent=(await provider.getNetwork()).name;
$("roleSelect").disabled=false;
};

$("roleSelect").onchange=e=>{
hide();
if(e.target.value) $(e.target.value).classList.remove("hidden");
};

async function reg(fn){
try{
const a=$("regAddr").value;
await contract[fn](a);
alert("Registered!");
}catch(e){alert(e.reason||e.message);}
}

async function createBatch(){
await contract.createBatch(
Number($("pbid").value),
$("pname").value,
Number($("pqty").value)
);
alert("Batch created");
}

async function addSensor(){
const h=Number($("hum").value);
if(h<0||h>100) return alert("Humidity must be 0–100");
await contract.addSensorData(
Number($("tbid").value),
Number($("temp").value),
h,
$("loc").value
);
alert("Sensor added");
}

async function transfer(){
await contract.transferOwnership(
Number($("dbid").value),
$("newOwner").value
);
alert("Transferred");
}

async function arrive(){
await contract.markAsArrived(
Number($("rbid").value),
$("passed").value==="true"
);
alert("Arrived");
}

async function view(){
const id=Number($("cbid").value);
const b=await contract.getBatchHistory(id);
$("out").textContent=JSON.stringify(b,null,2);
}

function genQR(){
const id=$("qrid").value;
const url=`${location.origin}${location.pathname}?batchId=${id}`;
$("qr").src=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
}

const q=new URLSearchParams(location.search).get("batchId");
if(q){ $("roleSelect").value="customer"; $("cbid").value=q; }
</script>
</body>
</html>
