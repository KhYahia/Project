<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FreshChain – Blockchain Traceability</title>
</head>

<body>

<h2>FreshChain – All-in-One Frontend</h2>

<button id="connectBtn">Connect MetaMask</button>
<p><b>Account:</b> <span id="account">-</span></p>

<hr>

<h3>Producer</h3>
<input id="bid" placeholder="Batch ID">
<input id="name" placeholder="Product Name">
<input id="qty" placeholder="Quantity">
<button id="createBtn" disabled>Create Batch</button>

<hr>

<h3>Transporter</h3>
<input id="sid" placeholder="Batch ID">
<input id="temp" placeholder="Temperature">
<input id="hum" placeholder="Humidity">
<input id="loc" placeholder="Location">
<button id="sensorBtn" disabled>Add Sensor Data</button>

<hr>

<h3>Ownership Transfer</h3>
<input id="tid" placeholder="Batch ID">
<input id="to" placeholder="New Owner Address">
<button id="transferBtn" disabled>Transfer Ownership</button>

<hr>

<h3>Retailer</h3>
<input id="rid" placeholder="Batch ID">
<button id="arriveBtn" disabled>Mark As Arrived</button>

<hr>

<h3>Customer</h3>
<input id="vid" placeholder="Batch ID">
<button id="viewBtn" disabled>View History</button>

<pre id="out"></pre>

<!-- ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
/* ===============================
   CONTRACT CONFIG
================================ */
const CONTRACT_ADDRESS = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";

const ABI = [
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"int256","name":"temperature","type":"int256"},{"internalType":"int256","name":"humidity","type":"int256"},{"internalType":"string","name":"location","type":"string"}],"name":"addSensorData","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"createBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"bool","name":"passed","type":"bool"}],"name":"markAsArrived","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"}],"name":"getBatchHistory","outputs":[{"components":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"uint256","name":"quantity","type":"uint256"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"bool","name":"arrived","type":"bool"},{"internalType":"bool","name":"inspectionPassed","type":"bool"},{"components":[{"internalType":"int256","name":"temperature","type":"int256"},{"internalType":"int256","name":"humidity","type":"int256"},{"internalType":"string","name":"location","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"transporter","type":"address"}],"internalType":"struct FreshChain.SensorData[]","name":"sensors","type":"tuple[]"},{"components":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct FreshChain.Ownership[]","name":"ownerships","type":"tuple[]"},{"internalType":"bool","name":"exists","type":"bool"}],"internalType":"struct FreshChain.Batch","name":"","type":"tuple"}],"stateMutability":"view","type":"function"}
];

let provider, signer, contract;

/* ===============================
   VALIDATION HELPERS
================================ */
function requireValue(v, msg) {
  if (v === undefined || v === null || v === "") {
    throw new Error(msg);
  }
}

function requireAddress(addr) {
  if (!ethers.utils.isAddress(addr)) {
    throw new Error("Invalid Ethereum address");
  }
}

/* ===============================
   CONNECT METAMASK
================================ */
document.getElementById("connectBtn").addEventListener("click", async () => {
  if (!window.ethereum) return alert("MetaMask not installed");

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  const account = await signer.getAddress();
  document.getElementById("account").innerText = account;

  ["createBtn","sensorBtn","transferBtn","arriveBtn","viewBtn"]
    .forEach(id => document.getElementById(id).disabled = false);
});

/* ===============================
   CREATE BATCH (PRODUCER)
================================ */
document.getElementById("createBtn").addEventListener("click", async () => {
  if (!contract) return alert("Connect MetaMask first");

  try {
    requireValue(bid.value, "Batch ID required");
    requireValue(name.value, "Product name required");
    requireValue(qty.value, "Quantity required");

    const tx = await contract.createBatch(
      Number(bid.value),
      name.value.trim(),
      Number(qty.value)
    );

    alert("Tx sent:\n" + tx.hash);
    await tx.wait();
    alert("✅ Batch created");
  } catch (e) {
    alert("❌ " + e.message);
  }
});

/* ===============================
   ADD SENSOR DATA (TRANSPORTER)
================================ */
document.getElementById("sensorBtn").addEventListener("click", async () => {
  if (!contract) return alert("Connect MetaMask first");

  try {
    requireValue(sid.value, "Batch ID required");
    requireValue(temp.value, "Temperature required");
    requireValue(hum.value, "Humidity required");
    requireValue(loc.value, "Location required");

    const tx = await contract.addSensorData(
      Number(sid.value),
      Number(temp.value),
      Number(hum.value),
      loc.value.trim()
    );

    alert("Tx sent:\n" + tx.hash);
    await tx.wait();
    alert("✅ Sensor data added");
  } catch (e) {
    alert("❌ " + e.message);
  }
});

/* ===============================
   TRANSFER OWNERSHIP
================================ */
document.getElementById("transferBtn").addEventListener("click", async () => {
  if (!contract) return alert("Connect MetaMask first");

  try {
    requireValue(tid.value, "Batch ID required");
    requireValue(to.value, "New owner address required");
    requireAddress(to.value);

    const tx = await contract.transferOwnership(
      Number(tid.value),
      to.value
    );

    alert("Tx sent:\n" + tx.hash);
    await tx.wait();
    alert("✅ Ownership transferred");
  } catch (e) {
    alert("❌ " + e.message);
  }
});

/* ===============================
   MARK AS ARRIVED (RETAILER)
================================ */
document.getElementById("arriveBtn").addEventListener("click", async () => {
  if (!contract) return alert("Connect MetaMask first");

  try {
    requireValue(rid.value, "Batch ID required");

    const tx = await contract.markAsArrived(
      Number(rid.value),
      true
    );

    alert("Tx sent:\n" + tx.hash);
    await tx.wait();
    alert("✅ Batch marked as arrived");
  } catch (e) {
    alert("❌ " + e.message);
  }
});

/* ===============================
   VIEW HISTORY (CUSTOMER)
================================ */
document.getElementById("viewBtn").addEventListener("click", async () => {
  if (!contract) return alert("Connect MetaMask first");

  try {
    requireValue(vid.value, "Batch ID required");

    const data = await contract.getBatchHistory(
      Number(vid.value)
    );

    document.getElementById("out").innerText =
      JSON.stringify(data, null, 2);
  } catch (e) {
    alert("❌ " + e.message);
  }
});
</script>

</body>
</html>
