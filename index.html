<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FreshChain – Management Panel</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<style>
body { font-family: Arial; margin: 20px; }
.card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
.hidden { display: none; }
button { padding: 6px 10px; }
input, select { padding: 6px; margin-right: 5px; }
pre { background: #f7f7f7; padding: 10px; border-radius: 6px; }
</style>
</head>

<body>

<h2>FreshChain – Management Panel</h2>

<div class="card">
  <button id="connect">Connect MetaMask</button>
  <p><b>Account:</b> <span id="account">-</span></p>
  <p><b>Network:</b> <span id="network">-</span></p>
</div>

<div class="card">
  <label>Select Role:</label>
  <select id="role">
    <option value="">-- select --</option>
    <option value="admin">Admin</option>
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="distributor">Distributor</option>
    <option value="retailer">Retailer</option>
    <option value="customer">Customer</option>
  </select>
</div>

<!-- ADMIN -->
<div class="card hidden" id="admin">
<h3>Admin – Register Roles</h3>
<input id="regAddr" placeholder="User address">
<button onclick="register('registerProducer')">Producer</button>
<button onclick="register('registerTransporter')">Transporter</button>
<button onclick="register('registerDistributor')">Distributor</button>
<button onclick="register('registerRetailer')">Retailer</button>
</div>

<!-- PRODUCER -->
<div class="card hidden" id="producer">
<h3>Producer – Create Batch</h3>
<input id="pbid" placeholder="Batch ID">
<input id="pname" placeholder="Product Name">
<input id="pqty" placeholder="Quantity">
<button onclick="createBatch()">Create</button>
</div>

<!-- TRANSPORTER -->
<div class="card hidden" id="transporter">
<h3>Transporter – Add Sensor Data</h3>
<input id="tbid" placeholder="Batch ID">
<input id="temp" placeholder="Temp">
<input id="hum" placeholder="Humidity">
<input id="loc" placeholder="Location">
<button onclick="addSensor()">Add</button>
</div>

<!-- DISTRIBUTOR -->
<div class="card hidden" id="distributor">
<h3>Distributor – Transfer Ownership</h3>
<input id="dbid" placeholder="Batch ID">
<input id="to" placeholder="New Owner">
<button onclick="transfer()">Transfer</button>
</div>

<!-- RETAILER -->
<div class="card hidden" id="retailer">
<h3>Retailer – Mark Arrived</h3>
<input id="rbid" placeholder="Batch ID">
<select id="passed">
<option value="true">Inspection Passed</option>
<option value="false">Inspection Failed</option>
</select>
<button onclick="arrive()">Confirm</button>
</div>

<!-- CUSTOMER -->
<div class="card hidden" id="customer">
<h3>Generate QR Code</h3>
<input id="qrBatch" placeholder="Batch ID">
<button id="genQR">Generate QR</button>
<div id="qr"></div>
</div>

<script>
const CONTRACT = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";
const ABI = [
  "function createBatch(uint,string,uint)",
  "function addSensorData(uint,int,int,string)",
  "function transferOwnership(uint,address)",
  "function markAsArrived(uint,bool)",
  "function registerProducer(address)",
  "function registerTransporter(address)",
  "function registerDistributor(address)",
  "function registerRetailer(address)"
];

let provider, signer, contract;

connect.onclick = async () => {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT, ABI, signer);
  account.textContent = await signer.getAddress();
  network.textContent = (await provider.getNetwork()).name;
};

role.onchange = () => {
  document.querySelectorAll(".card.hidden").forEach(d=>d.style.display="none");
  if(role.value) document.getElementById(role.value).style.display="block";
};

function register(fn){ contract[fn](regAddr.value); }
function createBatch(){ contract.createBatch(pbid.value,pname.value,pqty.value); }
function addSensor(){ contract.addSensorData(tbid.value,temp.value,hum.value,loc.value); }
function transfer(){ contract.transferOwnership(dbid.value,to.value); }
function arrive(){ contract.markAsArrived(rbid.value, passed.value==="true"); }

genQR.onclick = () => {
  const id = qrBatch.value;
  const url = `${location.origin}/Project/scan.html?batchId=${id}`;
  qr.innerHTML="";
  new QRCode(qr,{text:url,width:180,height:180});
  const a=document.createElement("a");
  a.href=url;a.textContent=url;a.target="_blank";
  qr.appendChild(a);
};
</script>
</body>
</html>
