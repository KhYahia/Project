<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Product History</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 24px; }
pre {
  background: #f9f9f9;
  padding: 16px;
  border-radius: 8px;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<h2>Product Supply Chain History</h2>
<p id="status">Loading history...</p>
<pre id="output"></pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONTRACT = "0xf066D2C372fD298108541E7c6a36e4BD42706FE5";

const ABI = [
  "function getBatchHistory(uint256) view returns (tuple(uint256 batchId,string productName,uint256 quantity,address producer,address distributor,address retailer,address currentOwner,bool arrived,bool inspectionPassed,tuple(int256 temperature,int256 humidity,string location,uint256 timestamp,address transporter)[] sensors,tuple(address from,address to,uint256 timestamp)[] ownerships,bool exists))"
];

const params = new URLSearchParams(window.location.search);
const batchId = params.get("batchId");

if (!batchId) {
  document.getElementById("status").innerText = "❌ No batch ID provided.";
  throw "";
}

const provider = new ethers.providers.JsonRpcProvider(
  "https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_KEY"
);

async function loadHistory() {
  const contract = new ethers.Contract(CONTRACT, ABI, provider);
  const b = await contract.getBatchHistory(batchId);

  let text = "";
  text += `Batch ID: ${b.batchId}\n`;
  text += `Product: ${b.productName}\n`;
  text += `Quantity: ${b.quantity}\n\n`;

  text += `Producer: ${b.producer}\n`;
  text += `Distributor: ${b.distributor}\n`;
  text += `Retailer: ${b.retailer}\n`;
  text += `Current Owner: ${b.currentOwner}\n\n`;

  text += `Inspection Passed: ${b.inspectionPassed}\n\n`;

  text += `--- SENSOR DATA ---\n`;
  if (b.sensors.length === 0) {
    text += "No sensor data\n";
  } else {
    b.sensors.forEach((s, i) => {
      text += `#${i + 1}\n`;
      text += `  Transporter: ${s.transporter}\n`;
      text += `  Temp: ${s.temperature}°C\n`;
      text += `  Humidity: ${s.humidity}%\n`;
      text += `  Location: ${s.location}\n`;
      text += `  Time: ${new Date(s.timestamp * 1000).toLocaleString()}\n\n`;
    });
  }

  text += `--- OWNERSHIP HISTORY ---\n`;
  b.ownerships.forEach((o, i) => {
    text += `#${i + 1}: ${o.from} → ${o.to}\n`;
    text += `  Time: ${new Date(o.timestamp * 1000).toLocaleString()}\n`;
  });

  document.getElementById("status").innerText = "✅ History loaded";
  document.getElementById("output").innerText = text;
}

loadHistory();
</script>

</body>
</html>

