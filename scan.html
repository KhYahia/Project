<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain ‚Äì Blockchain Product Traceability</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
body { font-family: Arial; margin: 20px; }
.card { border:1px solid #ddd; padding:15px; border-radius:8px; }
pre { background:#f7f7f7; padding:10px; border-radius:6px; }
</style>
</head>

<body>

<h2>üì¶ FreshChain ‚Äì Blockchain Product Traceability</h2>

<div class="card">
  <pre id="out">Loading history...</pre>
</div>

<script>
// üîπ CHANGE THIS TO YOUR ALCHEMY RPC
const RPC_URL = "https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY";

const CONTRACT_ADDRESS = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";

const ABI = [
  "function getBatchHistory(uint256) view returns (tuple(uint256,string,uint256,address,bool,bool,tuple(int256,int256,string,uint256,address)[],tuple(address,address,uint256)[],bool))"
];

// 1Ô∏è‚É£ Read batchId from QR URL
const params = new URLSearchParams(window.location.search);
const batchId = params.get("batchId");

if (!batchId) {
  document.getElementById("out").textContent = "‚ùå No batchId found in QR code.";
  throw new Error("No batchId");
}

(async () => {
  try {
    const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    const b = await contract.getBatchHistory(batchId);

    if (!b.exists) {
      document.getElementById("out").textContent = "‚ùå Batch does not exist.";
      return;
    }

    let text = `
Batch ID: ${b.batchId}
Product: ${b.productName}
Quantity: ${b.quantity}
Current Owner: ${b.currentOwner}
Arrived: ${b.arrived}
Inspection Passed: ${b.inspectionPassed}

================ SENSOR LOGS ================
`;

    if (b.sensors.length === 0) {
      text += "No sensor data recorded.\n";
    } else {
      b.sensors.forEach((s, i) => {
        text += `
#${i + 1}
Temperature: ${s.temperature} ¬∞C
Humidity: ${s.humidity} %
Location: ${s.location}
Time: ${new Date(s.timestamp * 1000).toLocaleString()}
Transporter: ${s.transporter}
`;
      });
    }

    text += `
================ OWNERSHIP HISTORY ================
`;

    if (b.ownerships.length === 0) {
      text += "No ownership transfers.\n";
    } else {
      b.ownerships.forEach((o, i) => {
        text += `
#${i + 1}
From: ${o.from}
To: ${o.to}
Time: ${new Date(o.timestamp * 1000).toLocaleString()}
`;
      });
    }

    document.getElementById("out").textContent = text;

  } catch (err) {
    document.getElementById("out").textContent =
      "‚ùå Error loading history.\n\n" + err.message;
    console.error(err);
  }
})();
</script>

</body>
</html>


