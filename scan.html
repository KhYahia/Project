<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Product History</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; margin: 24px; }
.card { border:1px solid #ddd; padding:16px; border-radius:10px; }
pre { background:#fafafa; padding:12px; border-radius:8px; white-space:pre-wrap; }
</style>
</head>

<body>

<h2>FreshChain – Product History</h2>

<div class="card">
  <pre id="out">Loading history...</pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONTRACT = "0x53E74EB95Ca391BD9d100F04582f8c128f125611";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/iZf1PfPx4JrG22mc06JQQ";

const ABI = [
  "function getBatchHistory(uint256) view returns (uint256,string,uint256,address,bool,bool,(int256,int256,string,uint256,address)[],(address,address,uint256)[],bool)"
];

const batchId = new URLSearchParams(location.search).get("batchId");

if (!batchId) {
  out.innerText = "❌ No batch ID provided.";
  throw "";
}

(async () => {
  try {
    const provider = new ethers.providers.JsonRpcProvider(RPC);
    const contract = new ethers.Contract(CONTRACT, ABI, provider);
    const b = await contract.getBatchHistory(batchId);

    let txt = `
Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}
Current Owner: ${b[3]}
Arrived: ${b[4]}
Inspection Passed: ${b[5]}

--- SENSOR LOGS ---
`;

    b[6].forEach((s,i)=>{
      txt += `
#${i+1}
Temp: ${s[0]} °C
Humidity: ${s[1]} %
Location: ${s[2]}
Time: ${new Date(Number(s[3])*1000).toLocaleString()}
Transporter: ${s[4]}
`;
    });

    txt += "\n--- OWNERSHIP HISTORY ---\n";

    b[7].forEach((o,i)=>{
      txt += `
#${i+1}
From: ${o[0]}
To: ${o[1]}
Time: ${new Date(Number(o[2])*1000).toLocaleString()}
`;
    });

    out.innerText = txt;

  } catch (e) {
    out.innerText =
      "❌ Error loading history.\n" +
      "Possible reasons:\n" +
      "- Batch ID does not exist\n" +
      "- Wrong contract address\n" +
      "- Wrong network (must be Sepolia)";
  }
})();
</script>

</body>
</html>





