<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FreshChain â€“ Product Traceability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; margin: 24px; }
    pre { background: #f7f7f7; padding: 16px; border-radius: 10px; }
  </style>
</head>
<body>

<h2>ðŸ“¦ FreshChain â€“ Blockchain Product Traceability</h2>

<pre id="out">Loading history...</pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const CONTRACT_ADDRESS = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";
const ABI = [
  "function getBatchHistory(uint256) view returns (tuple(uint256,string,uint256,address,bool,bool,tuple(int256,int256,string,uint256,address)[],tuple(address,address,uint256)[],bool))"
];

const provider = new ethers.providers.JsonRpcProvider(
  "https://sepolia.infura.io/v3/YOUR_INFURA_KEY"
);
const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

const batchId = new URLSearchParams(location.search).get("batchId");

(async () => {
  if (!batchId) {
    out.textContent = "No batch ID in QR.";
    return;
  }

  const b = await contract.getBatchHistory(batchId);
  if (!b.exists) {
    out.textContent = "Batch not found.";
    return;
  }

  let txt = `
Batch ID: ${b.batchId}
Product: ${b.productName}
Quantity: ${b.quantity}
Current Owner: ${b.currentOwner}
Arrived: ${b.arrived}
Inspection Passed: ${b.inspectionPassed}

--- Sensor Logs ---
`;

  b.sensors.forEach((s,i) => {
    txt += `
#${i+1}
Temp: ${s.temperature} Â°C
Humidity: ${s.humidity} %
Location: ${s.location}
Time: ${new Date(s.timestamp * 1000).toLocaleString()}
Transporter: ${s.transporter}
`;
  });

  txt += "\n--- Ownership History ---\n";

  b.ownerships.forEach((o,i) => {
    txt += `
#${i+1}
From: ${o.from}
To: ${o.to}
Time: ${new Date(o.timestamp * 1000).toLocaleString()}
`;
  });

  out.textContent = txt;
})();
</script>

</body>
</html>
