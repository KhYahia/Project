<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Product History</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body { font-family: Arial; margin: 24px; }
.card { border:1px solid #ddd; padding:16px; border-radius:10px; }
pre { background:#fafafa; padding:12px; border-radius:8px; white-space:pre-wrap; }
</style>
</head>

<body>

<h2>FreshChain – Product History</h2>

<div class="card">
  <pre id="out">Loading history...</pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONTRACT="0xd9145CCE52D386f254917e481eB44e9943F39138";
const RPC="https://eth-sepolia.g.alchemy.com/v2/iZf1PfPx4JrG22mc06JQQ";

const ABI=[
"function getBatchHistory(uint256) view returns (tuple(uint256,string,uint256,address,address,address,address,bool,bool,tuple(int256,int256,string,uint256,address)[],tuple(address,address,uint256)[],bool))"
];

const params=new URLSearchParams(location.search);
const batchId=params.get("batchId");
const out=document.getElementById("out");

if(!batchId){ out.innerText="❌ No batch ID provided"; }
else load();

async function load(){
 try{
  const provider=new ethers.providers.JsonRpcProvider(RPC);
  const contract=new ethers.Contract(CONTRACT,ABI,provider);
  const b=await contract.getBatchHistory(batchId);

  if(!b[12]) return out.innerText="❌ Batch does not exist";

  let txt=`Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}

Producer: ${b[3]}
Distributor: ${b[4]}
Retailer: ${b[5]}
Current Owner: ${b[6]}

Arrived: ${b[7]}
Inspection Passed: ${b[8]}

--- SENSOR LOGS ---\n`;

  b[9].forEach((s,i)=>{
    txt+=`#${i+1}
Temp: ${s[0]}°C
Humidity: ${s[1]}%
Location: ${s[2]}
Time: ${new Date(Number(s[3])*1000).toLocaleString()}
Transporter: ${s[4]}\n\n`;
  });

  txt+="--- OWNERSHIP HISTORY ---\n";
  b[10].forEach((o,i)=>{
    txt+=`#${i+1}
From: ${o[0]}
To: ${o[1]}
Time: ${new Date(Number(o[2])*1000).toLocaleString()}\n\n`;
  });

  out.innerText=txt;
 }catch(e){
  out.innerText="❌ Error loading history\n"+e.message;
 }
}
</script>

</body>
</html>



