<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>– Yahia Khanchouch – 220504543 – Blockchain Project</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body { font-family: Arial; margin: 24px; }
  .card { border:1px solid #ddd; padding:16px; border-radius:10px; }
  pre { background:#fafafa; padding:12px; border-radius:8px; }
</style>
</head>

<body>

<h2> FreshChain </h2>

<div class="card">
  <pre id="out">Loading history...</pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONTRACT = "0xAA5bEa655b35CDf1De2e8f224f6EeBF6C3Fb8a56";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/iZf1PfPx4JrG22mc06JQQ";

const ABI = [
  "function getBatchHistory(uint256) view returns (tuple(uint256,string,uint256,address,bool,bool,tuple(int256,int256,string,uint256,address)[],tuple(address,address,uint256)[],bool))"
];

const params = new URLSearchParams(location.search);
const batchId = params.get("batchId");

if (!batchId) {
  out.innerText = "No batch ID provided.";
} else {
  load();
}

async function load() {
  try {
    const provider = new ethers.providers.JsonRpcProvider(RPC);
    const contract = new ethers.Contract(CONTRACT, ABI, provider);
    const b = await contract.getBatchHistory(batchId);

    let txt = `
Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}
Current Owner: ${b[3]}
Arrived: ${b[4]}
Inspection Passed: ${b[5]}

--- SENSOR LOGS ---
`;

    b[6].forEach((s,i)=>{
      txt += `
#${i+1}
Temp: ${s[0]} °C
Humidity: ${s[1]} %
Location: ${s[2]}
Time: ${new Date(Number(s[3])*1000).toLocaleString()}
Transporter: ${s[4]}
`;
    });

    txt += "\n--- OWNERSHIP HISTORY ---\n";

    b[7].forEach((o,i)=>{
      txt += `
#${i+1}
From: ${o[0]}
To: ${o[1]}
Time: ${new Date(Number(o[2])*1000).toLocaleString()}
`;
    });

    out.innerText = txt;

  } catch (e) {
    out.innerText = "❌ Error loading history.\n" + e.message;
  }
}
</script>

</body>
</html>





