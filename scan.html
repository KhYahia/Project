<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Product Traceability</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
body { font-family: Arial; margin: 20px; }
.card { border:1px solid #ddd; padding:15px; border-radius:8px; }
pre { background:#f7f7f7; padding:10px; border-radius:6px; }
</style>
</head>

<body>
<h2> FreshChain – Blockchain Product Traceability</h2>

<div class="card">
<pre id="out">Loading history...</pre>
</div>

<script>
const CONTRACT = "0x92F8eFCB1cd479eE2c7FE9AaDAFEe6248B09e88F";
const ABI = [
"function getBatchHistory(uint) view returns (tuple(uint,string,uint,address,bool,bool,tuple(int,int,string,uint,address)[],tuple(address,address,uint)[],bool))"
];

const provider = new ethers.providers.JsonRpcProvider("https://rpc.sepolia.org");
const contract = new ethers.Contract(CONTRACT, ABI, provider);

const id = new URLSearchParams(window.location.search).get("batchId");
if(!id){ out.textContent="No batch ID in QR"; throw ""; }

(async ()=>{
  const b = await contract.getBatchHistory(id);
  if(!b.exists){ out.textContent="Batch not found"; return; }

  let t = `Batch ID: ${b.batchId}
Product: ${b.productName}
Quantity: ${b.quantity}
Owner: ${b.currentOwner}
Arrived: ${b.arrived}
Inspection Passed: ${b.inspectionPassed}

--- SENSOR LOGS ---
`;

  b.sensors.forEach((s,i)=>{
    t+=`#${i+1}
Temp: ${s.temperature}°C
Humidity: ${s.humidity}%
Location: ${s.location}
Time: ${new Date(s.timestamp*1000).toLocaleString()}
Transporter: ${s.transporter}

`;
  });

  t+=`--- OWNERSHIP HISTORY ---
`;
  b.ownerships.forEach((o,i)=>{
    t+=`#${i+1}
From: ${o.from}
To: ${o.to}
Time: ${new Date(o.timestamp*1000).toLocaleString()}

`;
  });

  out.textContent=t;
})();
</script>
</body>
</html>

